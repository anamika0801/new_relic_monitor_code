name: Update New Relic Monitor

on:
  workflow_dispatch:
    inputs:
      monitor_guid:
        description: 'GUID of the monitor'
        required: true
      account_id:
        description: 'New Relic Account ID'
        required: true
      api_key_secret_name:
        description: 'GitHub Secret Name for New Relic API Key'
        required: false
        default: NEW_RELIC_API_KEY # Assuming your secret is named this

jobs:
  disable-monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install JQ (if not available)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Update Monitor via NerdGraph
        env:
          NR_API_KEY: ${{ secrets[github.event.inputs.api_key_secret_name] || secrets.NEW_RELIC_API_KEY }}
          MONITOR_GUID: ${{ github.event.inputs.monitor_guid }}
          ACCOUNT_ID: ${{ github.event.inputs.account_id }}
          NEW_STATUS: "DISABLED" 
        
        run: |
          echo "ðŸ“´ Preparing to update the monitor fields..."

          if [ -z "$NR_API_KEY" ]; then
            echo "::error::New Relic API Key secret not found."
            exit 1
          fi

          # 1. Define the GraphQL Mutation
          # This mutation requires the GUID and the new status.
          MUTATION_PAYLOAD=$(jq -n \
            --arg guid "$MONITOR_GUID" \
            --arg status "$NEW_STATUS" \
            '{
              query: "mutation UpdateSyntheticMonitor($monitorGuid: EntityGuid!, $newStatus: SyntheticsMonitorStatus!, $newName: String!, $newPeriod: SyntheticsMonitorPeriod!) {syntheticsUpdateScriptApiMonitor(guid: $monitorGuid,monitor: {status: $newStatus,name: $newName,period: $newPeriod}) { errors { description type}monitor {guid name status}}}",
              variables: { $monitorGuid: guid!, $newStatus: status!, $newName: name!, $newPeriod: period! }}')

          # 2. Execute the Mutation using curl
          RESPONSE=$(curl -s -X POST https://api.newrelic.com/graphql \
            -H "Content-Type: application/json" \
            -H "API-Key: ${NR_API_KEY}" \
            --data-raw "$MUTATION_PAYLOAD")

          echo "ðŸ“¡ API Response: $RESPONSE"

           # 3. Check for Errors and Confirm Status
          UPDATE_ERRORS=$(echo "$RESPONSE" | jq -r '.data.syntheticsUpdateScriptApiMonitor.errors[].description' | tr '\n' ' ')
          FINAL_STATUS=$(echo "$RESPONSE" | jq -r '.data.syntheticsUpdateScriptApiMonitor.monitor.status')
          FINAL_NAME=$(echo "$RESPONSE" | jq -r '.data.syntheticsUpdateScriptApiMonitor.monitor.name')

          if [ -n "$UPDATE_ERRORS" ] && [ "$UPDATE_ERRORS" != "null" ]; then
            echo "::error::Monitor update failed: $UPDATE_ERRORS"
            exit 1
          elif [ "$FINAL_STATUS" == "$NEW_STATUS" ] && [ "$FINAL_NAME" == "$NEW_NAME" ]; then
            echo "âœ… Monitor $MONITOR_GUID successfully updated to status: $NEW_STATUS and name: $NEW_NAME."
          else
            echo "::error::Monitor update failed. Check API response for details."
            exit 1
          fi
