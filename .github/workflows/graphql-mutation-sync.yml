name: Update New Relic Monitor

on:
  workflow_dispatch:
    inputs:
      monitor_guid:
        description: 'GUID of the monitor'
        required: true
      account_id:
        description: 'New Relic Account ID'
        required: true
      api_key_secret_name:
        description: 'GitHub Secret Name for New Relic API Key'
        required: false
        default: NEW_RELIC_API_KEY # Assuming your secret is named this
      monitor_status:
        description: 'Desired status for the monitor'
        required: true
        default: ENABLED
      monitor_name:
        description: 'Desired name for the monitor'
        required: true
      monitor_period:
        description: 'Desired period for the monitor (e.g., EVERY_HOUR)'
        required: true
        default: EVERY_HOUR

jobs:
  update-monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install JQ (if not available)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Read the monitor script from file
        run: |
          MONITOR_SCRIPT=$(cat monitors/ap-api-monitor-conf-script.js)
          echo "Monitor script loaded successfully."

      - name: Update Monitor via NerdGraph
        env:
          NR_API_KEY: ${{ secrets[github.event.inputs.api_key_secret_name] || secrets.NEW_RELIC_API_KEY }}
          MONITOR_GUID: ${{ github.event.inputs.monitor_guid }}
          NEW_STATUS: ${{ github.event.inputs.monitor_status }}
          NEW_NAME: ${{ github.event.inputs.monitor_name }}
          NEW_PERIOD: ${{ github.event.inputs.monitor_period }}
          MONITOR_SCRIPT: ${{ env.MONITOR_SCRIPT }}
        
        run: |
          echo "ðŸ”„ Preparing to update the monitor fields for GUID: $MONITOR_GUID"

          if [ -z "$NR_API_KEY" ]; then
            echo "::error::New Relic API Key secret not found."
            exit 1
          fi

          # 1. Define the GraphQL Mutation Payload using JQ
          MUTATION_PAYLOAD=$(jq -n \
            --arg guid "$MONITOR_GUID" \
            --arg status "$NEW_STATUS" \
            --arg name "$NEW_NAME" \
            --arg period "$NEW_PERIOD" \
            --arg script "$MONITOR_SCRIPT" \
            '{
              query: "mutation UpdateSyntheticMonitor($monitorGuid: EntityGuid!, $monitorInput: SyntheticsUpdateScriptApiMonitorInput!) {\n  syntheticsUpdateScriptApiMonitor(\n    guid: $monitorGuid\n    monitor: $monitorInput\n  ) {\n    errors {\n      description\n      type\n    }\n    monitor {\n      guid\n      name\n      status\n    }\n  }\n}",
              variables: {
                monitorGuid: $guid,
                monitorInput: {
                  status: $status,
                  name: $name,
                  period: $period,
                  script: $script
                }
              }
            }')

          echo "Request Payload:"
          echo "$MUTATION_PAYLOAD" | jq . # Pretty print the payload for debugging

          # 2. Execute the Mutation using curl
          RESPONSE=$(curl -s -X POST https://api.newrelic.com/graphql \
            -H "Content-Type: application/json" \
            -H "API-Key: ${NR_API_KEY}" \
            --data-raw "$MUTATION_PAYLOAD")

          echo "ðŸ“¡ API Response: $RESPONSE"

          # 3. Check for Errors and Confirm Status/Name
          UPDATE_ERRORS=$(echo "$RESPONSE" | jq -r '.data.syntheticsUpdateScriptApiMonitor.errors[]?.description' | tr '\n' ' ')
          FINAL_STATUS=$(echo "$RESPONSE" | jq -r '.data.syntheticsUpdateScriptApiMonitor.monitor.status')
          FINAL_NAME=$(echo "$RESPONSE" | jq -r '.data.syntheticsUpdateScriptApiMonitor.monitor.name')

          if [ -n "$UPDATE_ERRORS" ] && [ "$UPDATE_ERRORS" != "null" ]; then
            echo "::error::Monitor update failed: $UPDATE_ERRORS"
            exit 1
          elif [ "$FINAL_STATUS" == "$NEW_STATUS" ] && [ "$FINAL_NAME" == "$NEW_NAME" ]; then
            echo "âœ… Monitor $MONITOR_GUID successfully updated. New status: $NEW_STATUS, New name: $NEW_NAME."
            echo "monitor_guid=$MONITOR_GUID" >> $GITHUB_OUTPUT 
          else
            echo "::error::Monitor update failed. Check API response for details."
            exit 1
          fi
